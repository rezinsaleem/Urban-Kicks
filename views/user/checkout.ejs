<%- include('../partials/userHeader') -%>

	<style>
		.custom-border {
			border: 1px solid #cacbcb !important;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
		}
	</style>

	<div class="colorlib-loader"></div>

	<div id="page">
		<nav class="colorlib-nav" role="navigation">
			<div class="top-menu">
				<div class="container">
					<div class="row">
						<div class="col-sm-7 col-md-9">
							<div id="colorlib-logo"><a href="/">Urban Kicks</a></div>
						</div>
						<div class="col-sm-5 col-md-3">
							<form action="/" id="searchForm" class="search-wrap">
								<div class="form-group">
									<input type="search" name="search" id="searchInput" class="form-control search" placeholder="Search">
									<button class="btn btn-primary submit-search text-center" type="submit"><i
											class="icon-search"></i></button>
								</div>
							</form>
						</div>
					</div>
					<div class="row">
						<div class="col-sm-12 text-left menu-1">
							<ul>
								<li class="<%= currentPage === 'home' ? 'active' : '' %>"><a href="/">Home</a></li>
								<% categories.forEach(category=> { %>
									<li class="<%= currentPage === category.id ? 'active' : '' %>"><a href="/shop/<%= category.id %>">
											<%= category.name %>
										</a></li>
									<% }); %>
										<li class="<%= currentPage === 'about' ? 'active' : '' %>"><a href="/about">About</a></li>
										<li class="<%= currentPage === 'contact' ? 'active' : '' %>"><a href="/contact">Contact</a></li>
										<li class="cart <%= currentPage === 'cart' ? 'active' : '' %>"><a href="/cart"><i
													class="icon-shopping-cart"></i> [0]</a></li>
										<li class="wishlist <%= currentPage === 'wishlist' ? 'active' : '' %>"><a href="/wishlist"><i
													class="icon-heart2"></i></a></li>
										<li class="user-profile <%= currentPage === 'profile' ? 'active' : '' %>"><a href="/profile"><i
													class="icon-user2"></i></a></li>

							</ul>
						</div>
					</div>
				</div>
			</div>
			<div class="sale">
				<div class="container">
					<div class="row">
						<div class="col-sm-8 offset-sm-2 text-center">
							<div class="row">
								<div class="owl-carousel2">
									<div class="item">
										<div class="col">
											<h3><a href="#">25% off (Almost) Everything! Use Code: Summer Sale</a></h3>
										</div>
									</div>
									<div class="item">
										<div class="col">
											<h3><a href="#">Our biggest sale yet 50% off all summer shoes</a></h3>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</nav>

		<div class="breadcrumbs">
			<div class="container">
				<div class="row">
					<div class="col">
						<p class="bread"><span><a href="/">Home</a></span> / <span>Checkout</span></p>
					</div>
				</div>
			</div>
		</div>


		<div class="colorlib-product">
			<div class="container">
				<form id="orderform">
					<div class="row row-pb-lg">
						<div class="col-sm-10 offset-md-1">
							<div class="process-wrap">
								<div class="process text-center active">
									<p><span>01</span></p>
									<h3>Shopping Cart</h3>
								</div>
								<div class="process text-center active">
									<p><span>02</span></p>
									<h3>Checkout</h3>
								</div>
								<div class="process text-center">
									<p><span>03</span></p>
									<h3>Order Complete</h3>
								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-lg-8">
							<div class="cart-detail">
								<h2>Billing Details</h2>
								<% if (errorMessages && errorMessages.length> 0) { %>
									<div class="alert alert-danger alert-dismissible fade show" role="alert">
										<button class="btn-close mt-2" style="float: right;" type="button" data-bs-dismiss="alert"
											aria-label="close"></button>
										<span style="font-weight: bold;">
											<%= errorMessages %>
										</span>
									</div>
									<% } %>

										<% if (successMessages && successMessages.length> 0) { %>
											<div class="alert alert-danger alert-dismissible fade show" role="alert">
												<button class="btn-close mt-2" style="float: right;" type="button" data-bs-dismiss="alert"
													aria-label="close"></button>
												<span style="font-weight: bold;">
													<%= successMessages %>
												</span>
											</div>
											<% } %>

												<div class="address-list text-center">
													<% if (address && address.address) { %>
														<% address.address.forEach((address,index)=> { %>
															<div class="address-item btn border mt-3 ml-2">
																<label for="address<%= index + 1 %>">
																	<input type="radio" name="address" id="address<%= index+1 %>" value="<%= index %>"
																		class="address-radio" data-address-id="<%= address._id %>" >
																	<span class="larger-text font-weight-bold text-black">
																		<%= address.save_as %>
																	</span>
																	<div class="address-details larger-text mt-2">
																		<p><span class="key">Full Name: </span>
																			<%= address.name %>
																		</p>
																		<p><span class="key">House name/Flat no:</span>
																			<%= address.housename %>
																		</p>
																		<p><span class="key">Street:</span>
																			<%= address.street %>
																		</p>
																		<p><span class="key">City:</span>
																			<%= address.city %>
																		</p>
																		<p><span class="key">Pin-Code:</span>
																			<%= address.pincode %>
																		</p>
																		<p><span class="key">State:</span>
																			<%= address.state %>
																		</p>
																		<p><span class="key">Country:</span>
																			<%= address.country %>
																		</p>
																	</div>
																</label>
															</div>
															<% }); %>
																<% } else { %>
																	<div>No addresses found.</div>
																	<% } %>
												</div>
												<div>
													<a class="btn btn-primary mt-5" href="/addAddress">Add Address</a>
												</div>
							</div>

							<div class="p-3 p-lg-5 cart-detail">
								<h2>Coupon Code</h2>
								<label for="c_code" class="text-black">Enter your coupon code if you have one!</label>
								<div class="input-group w-75">
									<input type="text" class="form-control custom-border" id="c_code" placeholder="Coupon Code"
										aria-label="Coupon Code" aria-describedby="button-addon2">
									<div class="input-group-append">
										<button class="btn btn-primary btn-sm my-auto" type="button" id="button-addon2"
											onclick="couponApply()">Apply</button>
									</div>
								</div>
								<div class="mt-3 d-flex">
									<button class="btn btn-outline-dark btn-sm" type="button" id="button-addon3"
									onclick="couponRevoke()">Clear</button>
										<button onclick="openModal()" class="btn btn-outline-dark mx-2">Available Coupons</button>
								</div>
						
								<div id="couponModal" class="modal">
										<div class="modal-content">
												<span class="close" onclick="closeModal()">&times;</span>
												<ul>
														<% if (availableCoupons.length > 0) { %>
																<% availableCoupons.forEach(coupon => { %>
																		<li>
																				<!-- <div class="row">
																						<div class="col-6"> -->
																								<%= coupon.couponCode %> &nbsp;&nbsp;
																								<% if (coupon.type === "percentageDiscount") { %>
																										<p><%= coupon.discount %>% off on Rs.<%= coupon.minimumPrice %> purchase (Maximum Redeemable: <%= coupon.maxRedeem %>)</p><br>
																								<% } else { %>
																										<p>Flat Rs. <%= coupon.discount %> off on <%= coupon.minimumPrice %> purchase</p><br>
																								<% } %>
																						<!-- </div>
																						<div class="col-6 mt-2"> -->
																								<button onclick="copyToClipboard('<%= coupon.couponCode %>')">Copy Code</button>
																						<!-- </div>
																				</div> -->
																		</li>
																<% }); %>
														<% } else { %>
																<li>
																		<p>No coupons available</p>
																</li>
														<% } %>
												</ul>
										</div>
								</div>
						</div>
						
						</div>

						<div class="col-lg-4">
							<div class="row">
								<div class="col-md-12">
									<div class="cart-detail">
										<input type="hidden" name="cartId" value="<%= data._id %>">
										<input type="hidden" id="amount" name="amount" value="<%= data.total %>" />
										<h2>Cart Total</h2>
										<ul>
											<li>
												<span>Subtotal</span> <span>₹ <span id="subt">
														<%= data.total %>
													</span>.00</span>
												<ul>
													<% data.item.forEach((item)=> { %>
														<li><span>
																<%= item.quantity %> x <%= item.productId.description %>
															</span> <span>₹ <%= item.total %>.00</span></li>
														<% }); %>
												</ul>
											</li>
											<li><span>Discount</span>₹ <span id="dicprice">0</span>.00</li>
											<li style="font-weight: bold;"><span>Order Total</span> <span id="total">₹ <%= data.total %>
														.00</span></li>
										</ul>
									</div>
								</div>

								<div class="col-md-12">
									<div class="cart-detail">
										<h2>Payment Method</h2>
										<div class="form-group">
											<div class="col-md-12">
												<div class="radio">
													<label><input type="radio" name="paymentOption" value="cashOnDelivery"
															onclick="handlePaymentMethodSelection()"> Cash On Delivery </label>
												</div>
											</div>
										</div>
										<div class="form-group">
											<div class="col-md-12">
												<div class="radio">
													<label><input type="radio" name="paymentOption" value="upi"
															onclick="handlePaymentMethodSelection()"> Online payment </label>
												</div>
											</div>
										</div>
										<div class="form-group">
											<div class="col-md-12">
												<div class="radio">
													<label><input type="radio" name="paymentOption" value="wallet"
															onclick="handlePaymentMethodSelection()"> Wallet </label>
												</div>
											</div>
										</div>
									</div>
								</div>
							</div>
							<input type="hidden" id="pay" name="pay" value="0" />
							<div class="row">
								<div class="col-md-12 text-center">
									<button id="placeOrderBtn" class="btn btn-primary w-50" onclick="proceedToOrder()">Place
										Order</button>
								</div>
							</div>

						</div>
					</div>
				</form>
			</div>
		</div>

		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
		<script>
			function handlePaymentMethodSelection() {
				const selectedPaymentMethod = document.querySelector(
					'input[name="paymentOption"]:checked'
				);
				if (selectedPaymentMethod) {
					const hiddenInput = document.getElementById("pay");
					hiddenInput.value = selectedPaymentMethod.value;
				}
			}
			document.getElementById('placeOrderBtn').addEventListener('click', function (event) {
				event.preventDefault();
				proceedToOrder();
			});

			function proceedToOrder() {
				var selectedAddress = document.querySelector('input[name="address"]:checked');
				var selectedPayment = document.querySelector('input[name="paymentOption"]:checked');

				if (!selectedAddress) {
					console.log("Address not selected");
					Swal.fire({
						text: "Select the delivery address",
						icon: "error",
						confirmButtonText: "OK",
						customClass: {
							title: "text-danger",
							popup: "swal2-popup-custom",
							confirmButton: "btn btn-danger",
						},
						showCancelButton: false,
						showCloseButton: true,
						showLoaderOnConfirm: false
					});
				} else if (!selectedPayment) {
					console.log("Payment option not selected");
					Swal.fire({
						text: "Select a Payment option",
						icon: "error",
						confirmButtonText: "OK",
						customClass: {
							title: "text-danger",
							popup: "swal2-popup-custom",
							confirmButton: "btn btn-danger",
						},
						showCancelButton: false,
						showCloseButton: true,
						showLoaderOnConfirm: false
					});
				} else if (selectedPayment.value == 'upi') {
					const amt = document.getElementById("total").textContent.trim();
					const amount = parseFloat(amt.replace(/[^0-9.-]/g, ''));
					console.log(parseFloat(amount))
					var options = {
						key: 'rzp_test_3TxK9TdVgtd1BD',
						amount: parseFloat(amount) * 100,
						currency: "INR",
						name: "UrbanKicks",
						description: "Test Transaction",
						image: "https://i.ibb.co/Jxd5tjS/uklogo.jpg",
						order_id: orderId,
						handler: function (response) {
							// alert(response.razorpay_payment_id);

							document.getElementById("amount").value = `${amount}`;
							document.getElementById("orderform").method = "post";
							document.getElementById("orderform").action = "/order";
							document.getElementById("orderform").submit();
						},

						theme: {
							color: "#afb5f9",
						},
					};
					var rzp1 = new Razorpay(options);
					rzp1.on("payment.failed", function (response) {
						alert(response.error.code);
						alert(response.error.description);
						alert(response.error.source);
						alert(response.error.step);
						alert(response.error.reason);
						alert(response.error.metadata.payment_id);
					});
					rzp1.open();

					event.preventDefault();

					var orderId;
					$(document).ready(function () {
						var settings = {
							url: "/create/orderId",
							method: "POST",
							timeout: 0,
							headers: {
								"Content-Type": "application/json",
							},
							data: JSON.stringify({
								amount: parseFloat(amount) * 100,
							}),
						};

						$.ajax(settings).done(function (response) {
							orderId = response.orderId;
							console.log(orderId);
							$("button").show();
						});
					});

				} else if (selectedPayment.value == "cashOnDelivery") {
					console.log("Cash on Delivery selected");
					document.getElementById("orderform").action = "/order";
					document.getElementById("orderform").method = "post";
					document.getElementById("orderform").submit();
					const amount = document.getElementById("total").textContent.trim();
					document.getElementById("total").innerText = `${amount}`;
					document.getElementById("amount").value = `${amount}`;
				}
			}
		</script>

		<script>
			function openModal() {
				event.preventDefault();
				var modal = document.getElementById('couponModal');
				modal.style.display = 'block';
			}

			function closeModal() {
				var modal = document.getElementById('couponModal');
				modal.style.display = 'none';
			}

			function copyToClipboard(couponCode) {
				var tempInput = document.createElement('input');
				tempInput.value = couponCode;
				document.body.appendChild(tempInput);

				tempInput.select();
				document.execCommand('copy');

				document.body.removeChild(tempInput);


			}

			document.addEventListener('DOMContentLoaded', function () {
				// Close the modal if the user clicks outside of it
				window.addEventListener('click', function (event) {
					var modal = document.getElementById('couponModal');
					if (event.target === modal) {
						closeModal();
					}
				});
			});
		</script>

		<script>

			function couponApply() {
				const couponCode = document.getElementById('c_code').value;
				const subtotal = document.getElementById('subt').innerText

				fetch('/applyCoupon', {
					method: "POST",
					headers: {
						'Content-Type': "application/json"
					},
					body: JSON.stringify({ couponCode, subtotal })
				})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							Swal.fire({
								text: "coupon applied",
								icon: 'success',
								confirmButtonText: 'OK',
								customClass: {
									title: 'text-danger',
									popup: 'swal2-popup-custom',
									confirmButton: 'btn btn-danger'
								},
								showCancelButton: false,
								showCloseButton: true,
								showLoaderOnConfirm: false,
								timer: 3000
							});
							console.log("ivideumethi")
							document.getElementById('dicprice').innerText = "-" + data.dicprice
							document.getElementById('total').innerText = `${data.price}`
							document.getElementById('amount').value = `${data.price}`



						} else {
							Swal.fire({
								text: data.message,
								icon: 'error',
								confirmButtonText: 'OK',
								customClass: {
									title: 'text-danger',
									popup: 'swal2-popup-custom',
									confirmButton: 'btn btn-danger'
								},
								showCancelButton: false,
								showCloseButton: true,
								showLoaderOnConfirm: false,
								timer: 3000
							});
						}
					})
					.catch(error => {
						console.error('Error applying coupon:', error);
						alert('An error occurred while applying the coupon. Please try again.');
					});
			}

			function couponRevoke() {

				const couponCode = document.getElementById('c_code').value;
				const subtotal = document.getElementById('subt').innerText

				fetch('/revokeCoupon', {
					method: "POST",
					headers: {
						'Content-Type': "application/json"
					},
					body: JSON.stringify({ couponCode, subtotal })
				})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							Swal.fire({
								text: "coupon revoked",
								icon: 'success',
								confirmButtonText: 'OK',
								customClass: {
									title: 'text-danger',
									popup: 'swal2-popup-custom',
									confirmButton: 'btn btn-danger'
								},
								showCancelButton: false,
								showCloseButton: true,
								showLoaderOnConfirm: false,
								timer: 3000
							});
							document.getElementById('dicprice').innerText = 0
							document.getElementById('total').innerText = `${data.price}`
							document.getElementById('amount').value = `${data.price}`
							document.getElementById('c_code').value = ""




						} else {
							Swal.fire({
								text: data.message,
								icon: 'error',
								confirmButtonText: 'OK',
								customClass: {
									title: 'text-danger',
									popup: 'swal2-popup-custom',
									confirmButton: 'btn btn-danger'
								},
								showCancelButton: false,
								showCloseButton: true,
								showLoaderOnConfirm: false,
								timer: 3000
							});
						}
					})
					.catch(error => {
						console.error('Error applying coupon:', error);
						alert('An error occurred while applying the coupon. Please try again.');
					});
			}


		</script>

		<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
		<!-- Bootstrap Bundle with Popper -->
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
		<%- include('../partials/userFooter') -%>